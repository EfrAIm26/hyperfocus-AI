// --- ESTADO Y PERSISTENCIA ---
let appState = {};
const defaultState = {
    activeContext: { type: 'new_chat', id: null },
    courses: [],
    topics: {},
    chats: {},
    ui: { collapsed: {} }
};

function saveState() {
    localStorage.setItem('hyperfocusState', JSON.stringify(appState));
}

function loadState() {
    const savedState = localStorage.getItem('hyperfocusState');
    appState = savedState ? JSON.parse(savedState) : JSON.parse(JSON.stringify(defaultState));
}

// --- DOM ELEMENTS ---
const elements = {
    modal: document.getElementById('custom-prompt-modal'), modalTitle: document.getElementById('modal-title'), modalInput: document.getElementById('modal-input'), modalCancelBtn: document.getElementById('modal-cancel-btn'), modalAcceptBtn: document.getElementById('modal-accept-btn'),
    contextMenu: document.getElementById('context-menu'), colorPicker: document.getElementById('color-picker'),
    loginBtn: document.getElementById('login-btn'), authButtons: document.getElementById('auth-buttons'), sidebar: document.getElementById('sidebar'),
    addCourseBtn: document.getElementById('add-course-btn'), coursesList: document.getElementById('courses-list'), historyList: document.getElementById('history-list'),
    currentContextTitle: document.getElementById('current-context-title'), chatHistory: document.getElementById('chat-history'),
    userInput: document.getElementById('user-input'), modelSelect: document.getElementById('model-select'), sendButton: document.getElementById('send-button'), disclaimer: document.getElementById('disclaimer'),
};

let modalResolve = null;

// --- RENDERIZADO DE LA UI ---
function render() {
    renderSidebar();
    renderChatView();
}

function renderSidebar() {
    const { courses, topics, chats, ui, activeContext } = appState;
    elements.coursesList.innerHTML = '';
    elements.historyList.innerHTML = '';
    
    courses.forEach(course => elements.coursesList.appendChild(createCourseElement(course)));
    Object.values(chats).filter(c => !c.parentId).forEach(chat => elements.historyList.appendChild(createChatElement(chat)));
}

function createCourseElement(course) {
    const isCollapsed = appState.ui.collapsed[course.id];
    const li = document.createElement('li');
    li.innerHTML = `
        <div class="sidebar-item ${appState.activeContext.id === course.id ? 'active' : ''}" data-id="${course.id}" data-type="course">
            <span class="toggle-arrow ${isCollapsed ? 'collapsed' : ''}">▼</span>
            <span class="color-dot" style="background-color: ${course.color || '#888'}"></span>
            <span class="item-name">${course.name}</span>
            <button class="item-menu-btn" data-id="${course.id}" data-type="course">...</button>
        </div>
    `;
    const nestedUl = document.createElement('ul');
    nestedUl.className = 'nested-list';
    if (!isCollapsed) {
        Object.values(appState.topics).filter(t => t.parentId === course.id).forEach(topic => nestedUl.appendChild(createTopicElement(topic)));
        Object.values(appState.chats).filter(c => c.parentId === course.id).forEach(chat => nestedUl.appendChild(createChatElement(chat)));
    }
    li.appendChild(nestedUl);
    return li;
}

function createTopicElement(topic) {
    const isCollapsed = appState.ui.collapsed[topic.id];
    const li = document.createElement('li');
    li.innerHTML = `
         <div class="sidebar-item ${appState.activeContext.id === topic.id ? 'active' : ''}" data-id="${topic.id}" data-type="topic">
            <span class="toggle-arrow ${isCollapsed ? 'collapsed' : ''}">▼</span>
            <span class="color-dot" style="background-color: ${topic.color || '#888'}"></span>
            <span class="item-name">${topic.name}</span>
            <button class="item-menu-btn" data-id="${topic.id}" data-type="topic">...</button>
        </div>
    `;
    const nestedUl = document.createElement('ul');
    nestedUl.className = 'nested-list';
    if (!isCollapsed) {
        Object.values(appState.chats).filter(c => c.parentId === topic.id).forEach(chat => nestedUl.appendChild(createChatElement(chat)));
    }
    li.appendChild(nestedUl);
    return li;
}

function createChatElement(chat) {
    const li = document.createElement('li');
    li.innerHTML = `
        <div class="sidebar-item ${appState.activeContext.id === chat.id ? 'active' : ''}" data-id="${chat.id}" data-type="chat">
            <span class="toggle-arrow" style="opacity: 0;">▼</span>
            <span class="item-name">${chat.title}</span>
        </div>
    `;
    return li;
}

function renderChatView() {
    const { type, id } = appState.activeContext;
    elements.chatHistory.innerHTML = '';
    let title = 'Hyperfocus AI - Inicio';

    if (type === 'chat') {
        const chat = appState.chats[id];
        title = getBreadcrumbs(chat);
        chat.messages.forEach(msg => addMessageToUI(msg.role === 'user', msg.content));
    } else if (type === 'topic') {
        const topic = appState.topics[id];
        title = getBreadcrumbs(topic);
        addMessageToUI(false, `Estas en el tema ${topic.name}. ¿Sobre qué quieres chatear?`);
    } else if (type === 'course') {
        const course = appState.courses.find(c => c.id === id);
        title = `Curso: ${course.name}`;
        addMessageToUI(false, `Bienvenido al curso ${course.name}. ¿Qué quieres aprender?`);
    }
    elements.currentContextTitle.textContent = title;
}

// --- LÓGICA DE LA APP ---
function setActiveContext(type, id) {
    appState.activeContext = { type, id };
    render();
    saveState();
}

function addMessageToUI(isUser, content) {
    const messageDiv = document.createElement('div');
    messageDiv.className = `message ${isUser ? 'user-message' : 'bot-message'}`;
    messageDiv.textContent = content;
    elements.chatHistory.appendChild(messageDiv);
    elements.chatHistory.scrollTop = elements.chatHistory.scrollHeight;
}

async function sendMessage() {
    const messageContent = elements.userInput.value.trim();
    if (!messageContent) return;
    addMessageToUI(true, messageContent);
    elements.userInput.value = '';

    let currentChat;
    if (appState.activeContext.type === 'chat') {
        currentChat = appState.chats[appState.activeContext.id];
    } else {
        const newChatId = `chat_${Date.now()}`;
        const parentId = (appState.activeContext.type === 'course' || appState.activeContext.type === 'topic') ? appState.activeContext.id : null;
        currentChat = {
            id: newChatId, title: messageContent.substring(0, 30) + '...', messages: [], type: 'chat', parentId: parentId
        };
        appState.chats[newChatId] = currentChat;
        setActiveContext('chat', newChatId);
    }
    
    currentChat.messages.push({ role: 'user', content: messageContent });

    try {
        const messagesToSend = currentChat.messages.map(m => ({ role: m.role, content: m.content }));
        
        const response = await fetch('/api/chat', {
            method: 'POST', headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ model: elements.modelSelect.value, messages: messagesToSend }),
        });
        const data = await response.json();
        if (data.error || !data.choices?.length) throw new Error(data.error?.message || "No se recibió respuesta válida.");
        
        const botReply = data.choices[0].message.content;
        addMessageToUI(false, botReply);
        currentChat.messages.push({ role: 'assistant', content: botReply });
        saveState();
    } catch (error) {
        addMessageToUI(false, `Error: ${error.message}`);
    }
}

// --- MANEJADORES DE EVENTOS Y ACCIONES ---
elements.loginBtn.addEventListener('click', () => {
    elements.authButtons.classList.add('hidden');
    elements.sidebar.classList.remove('hidden');
});

document.getElementById('sidebar').addEventListener('click', e => {
    const item = e.target.closest('.sidebar-item');
    if (item?.dataset.id) {
        if (e.target.classList.contains('toggle-arrow')) {
            appState.ui.collapsed[item.dataset.id] = !appState.ui.collapsed[item.dataset.id];
            renderSidebar();
            saveState();
        } else if (e.target.classList.contains('item-menu-btn')) {
            showContextMenu(e);
        } else {
            setActiveContext(item.dataset.type, item.dataset.id);
        }
    }
});

elements.addCourseBtn.addEventListener('click', () => handleAddItem('course', null));

// --- INICIALIZACIÓN ---
document.addEventListener('DOMContentLoaded', () => {
    loadState();
    render();

    // Attach remaining event listeners
    elements.sendButton.addEventListener('click', sendMessage);
    elements.userInput.addEventListener('keypress', e => { if (e.key === 'Enter') sendMessage(); });
});

// Helper functions for menu, modals, etc.
function showContextMenu(e) { /* Lógica del menú contextual */ }
function handleAddItem(type, parentId) { /* Lógica para añadir items */ }
function getBreadcrumbs(item) {
    if (!item.parentId) return item.title || item.name;
    const parent = appState.topics[item.parentId] || appState.courses.find(c => c.id === item.parentId);
    return `${getBreadcrumbs(parent)} / ${item.title || item.name}`;
}
// Añadir aquí la lógica completa para el menú contextual, modales, etc. que es demasiado extensa para este formato.